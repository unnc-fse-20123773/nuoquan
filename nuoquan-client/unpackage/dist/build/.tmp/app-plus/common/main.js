(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["common/main"],{"2cd4":function(t,e,n){"use strict";n.r(e);var o=n("a773"),a=n.n(o);for(var s in o)"default"!==s&&function(t){n.d(e,t,function(){return o[t]})}(s);e["default"]=a.a},"446c":function(t,e,n){},"4a7e":function(t,e,n){"use strict";n.r(e);var o=n("2cd4");for(var a in o)"default"!==a&&function(t){n.d(e,t,function(){return o[t]})}(a);n("5774");var s,r,i=n("2877"),c=Object(i["a"])(o["default"],s,r,!1,null,null,null);e["default"]=c.exports},5774:function(t,e,n){"use strict";var o=n("446c"),a=n.n(o);a.a},"7e2c":function(t,e,n){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o=s(n("f3d3")),a=s(n("2f62"));function s(t){return t&&t.__esModule?t:{default:t}}o.default.use(a.default);var r=t.getStorageSync("myMsgCount"),i=t.getStorageSync("likeMsgCount"),c=t.getStorageSync("commentMsgCount"),u=new a.default.Store({state:{chatMessageCard:"",flashChatPage:"doFlash",myMsgCount:null==r?0:r,likeMsgCount:null==i?0:i,commentMsgCount:null==c?0:c},mutations:{setChatMessageCard:function(t,e){t.chatMessageCard=e},doFlashChatPage:function(t,e){t.flashChatPage=(new Date).getTime()},setMyMsgCount:function(e,n){void 0==n?(e.myMsgCount++,t.setStorageSync("myMsgCount",e.myMsgCount)):(e.myMsgCount=n,t.setStorageSync("myMsgCount",e.myMsgCount))},setLikeMsgCount:function(e,n){void 0==n?(e.likeMsgCount++,t.setStorageSync("likeMsgCount",e.likeMsgCount)):(e.likeMsgCount=n,t.setStorageSync("likeMsgCount",e.likeMsgCount))},setCommentMsgCount:function(e,n){void 0==n?(e.commentMsgCount++,t.setStorageSync("commentMsgCount",e.commentMsgCount)):(e.commentMsgCount=n,t.setStorageSync("commentMsgCount",e.commentMsgCount))}}}),l=u;e.default=l}).call(this,n("6e42")["default"])},"9ebf":function(t,e,n){"use strict";(function(t){n("5ad9");var e=s(n("f3d3")),o=s(n("4a7e")),a=s(n("7e2c"));function s(t){return t&&t.__esModule?t:{default:t}}function r(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{},o=Object.keys(n);"function"===typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(n).filter(function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable}))),o.forEach(function(e){i(t,e,n[e])})}return t}function i(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}var c=new e.default(r({store:a.default},o.default));c.$mount(),o.default.mpType="app",e.default.config.productionTip=!1,e.default.prototype.version="v1.01 - 公测版",e.default.prototype.tagColors=["#FE5F55","#40A792","#FDD041","#5CA0D3","#621E81","#738598","#F3AE4B"],e.default.prototype.$store=a.default,e.default.prototype.$serverUrl="http://129.28.130.27:8080/nottinghome",e.default.prototype.$wsServerUrl="ws://129.28.130.27:8088/ws",e.default.prototype.setGlobalUserInfo=function(e){t.setStorageSync("userInfo",e)},e.default.prototype.getGlobalUserInfo=function(){var e=t.getStorageSync("userInfo");return e},e.default.prototype.removeGlobalUserInfo=function(){t.removeStorageSync("userInfo")},e.default.prototype.setIntoList=function(e,n){var o,a=t.getStorageSync(n);o=c.isNull(a)?[]:JSON.parse(a),o.push(e),t.setStorageSync(n,JSON.stringify(o))},e.default.prototype.addIntoList=function(e,n){var o,a=t.getStorageSync(n);o=c.isNull(a)?[]:JSON.parse(a),o.unshift(e),t.setStorageSync(n,JSON.stringify(o))},e.default.prototype.getListByKey=function(e){var n,o=t.getStorageSync(e);return n=c.isNull(o)?[]:JSON.parse(o),n},e.default.prototype.setUserInfoToUserList=function(e){var n=t.getStorageSync("userList");if(c.isNull(n))o=[];else for(var o=JSON.parse(n),a=0;a<o.length;a++){var s=o[a];if(s.id==e.id)return o.splice(a,1,e),void t.setStorageSync("userList",JSON.stringify(o))}o.push(e),t.setStorageSync("userList",JSON.stringify(o))},e.default.prototype.getUserInfoFromUserList=function(e){var n=t.getStorageSync("userList");if(c.isNull(n))return null;for(var o=JSON.parse(n),a=0;a<o.length;a++){var s=o[a];if(s.id==e)return s}return null},e.default.prototype.getCurrentPage=function(){var t=getCurrentPages(),e=t[t.length-1];return e},e.default.prototype.myUser=function(t){var e=t.email;this.isNull(e)&&(e="[Email]@nottingham.edu.cn");var n=e.split("@");return t.emailPrefix=n[0],t.emailSuffix="@"+n[1],t},e.default.prototype.isNull=function(t){return null==t||""==t||void 0==t},e.default.prototype.mySocket={isOpen:!1,socketMsgQueue:[],init:function(){var e=this;t.connectSocket({url:c.$wsServerUrl,complete:function(){}}),t.onSocketOpen(function(t){e.isOpen=!0,console.log("WebSocket连接已打开！isSocketOpen="+e.isOpen);var n=c.getGlobalUserInfo().id;if(c.isNull(n))console.log("请先获取用户数据");else{var o=new c.netty.DataContent(c.netty.CONNECT,null,n);e.sendDataContent(o);for(var a=0;a<e.socketMsgQueue.length;a++)e.socketMsgQueue[a].action==c.netty.CHAT&&e.sendDataContent(e.socketMsgQueue[a]);e.socketMsgQueue=[],c.chat.fetchUnsignedChatMsg(),c.notification.fetchUnsignedLikeMsg(),c.notification.fetchUnsignedCommentMsg(),setInterval(e.keepAlive,5e4)}}),t.onSocketError(function(t){console.log("WebSocket连接打开失败，请检查！")}),t.onSocketMessage(function(t){var n=JSON.parse(t.data);console.log("收到服务器内容："),console.log(n);var o=n.action;if(o==c.netty.CHAT||o==c.netty.LIKEARTICLE||o==c.netty.LIKECOMMENT||o==c.netty.COMMENTARTICLE||o==c.netty.COMMENTCOMMENT)switch(c.$store.commit("setMyMsgCount"),o){case c.netty.CHAT:var a=n.data;e.signMsgList(a.msgId);var s=a.receiverId,r=a.senderId,i=a.msg,u=c.formatTime(a.createDate);c.chat.saveUserChatHistory(s,r,i,c.chat.FRIEND,u);var l=c.getCurrentPage();if("pages/chatpage/chatpage"==l.route){var g=l.data.friendInfo.id;if(g==r){console.log("与该用户在聊天，标记为已读"),c.chat.saveUserChatSnapshot(s,r,i,c.chat.READ,u);var f=new c.chat.ChatHistory(s,r,i,c.chat.FRIEND,u);c.$store.commit("setChatMessageCard",f)}else console.log("不是与该用户聊天，标记为未读"),c.chat.saveUserChatSnapshot(s,r,i,c.chat.UNREAD,u)}else console.log("聊天页面未打开，标记为未读"),c.chat.saveUserChatSnapshot(s,r,i,c.chat.UNREAD,u);break;case c.netty.LIKEARTICLE:console.log("获取点赞文章"),e.signLikeArticleList(n.data.source.id),n.data.source.createDate=c.formatTime(n.data.source.createDate),c.notification.saveLikeMsg(n),c.$store.commit("setLikeMsgCount");break;case c.netty.LIKECOMMENT:console.log("获取点赞评论"),e.signLikeCommentList(n.data.source.id),n.data.source.createDate=c.formatTime(n.data.source.createDate),c.notification.saveLikeMsg(n),c.$store.commit("setLikeMsgCount");break;case c.netty.COMMENTARTICLE:console.log("获取评论文章"),e.signCommentList(n.data.source.id),n.data.source.createDate=c.formatTime(n.data.source.createDate),c.notification.saveCommentMsg(n),c.$store.commit("setCommentMsgCount");break;case c.netty.COMMENTCOMMENT:console.log("获取评论评论"),e.signCommentList(n.data.source.id),n.data.source.createDate=c.formatTime(n.data.source.createDate),c.notification.saveCommentMsg(n),c.$store.commit("setCommentMsgCount");break;default:break}}),t.onSocketClose(function(t){e.isOpen=!1,console.log("WebSocket 已关闭！isSocketOpen="+e.isOpen),console.log("重连中.."),setTimeout(function(){e.init()},3e3)})},sendObj:function(t,e,n,o){var a=c.getGlobalUserInfo().id;if(c.isNull(a))console.log("请先获取用户数据");else{var s=(new Date).getTime(),r=new c.netty.ChatMessage(a,e,n,null,s),i=new c.netty.DataContent(t,r,o),u=c.mySocket.isOpen;1==u?this.sendDataContent(i):(console.log("isSocketOpen="+u),this.socketMsgQueue.push(i),console.log(this.socketMsgQueue))}},sendDataContent:function(e){var n=JSON.stringify(e);if(t.sendSocketMessage({data:n}),e.action==c.netty.CHAT){var o=e.data,a=c.formatTime(o.createDate);c.chat.saveUserChatHistory(o.senderId,o.receiverId,o.msg,c.chat.ME,a),c.chat.saveUserChatSnapshot(o.senderId,o.receiverId,o.msg,c.chat.READ,a),c.$store.commit("doFlashChatPage")}},signMsgList:function(t){var e=new c.netty.DataContent(c.netty.SIGNED,null,t);this.sendDataContent(e)},signLikeArticleList:function(t){var e=new c.netty.DataContent(c.netty.LIKEARTICLE_SIGN,null,t);this.sendDataContent(e)},signLikeCommentList:function(t){var e=new c.netty.DataContent(c.netty.LIKECOMMENT_SIGN,null,t);this.sendDataContent(e)},signCommentList:function(t){var e=new c.netty.DataContent(c.netty.COMMENT_SIGN,null,t);this.sendDataContent(e)},keepAlive:function(){var t=new c.netty.DataContent(c.netty.KEEPALIVE,null,null);c.mySocket.sendDataContent(t)}},e.default.prototype.chat={ME:1,FRIEND:2,READ:3,UNREAD:4,ChatHistory:function(t,e,n,o,a){this.myId=t,this.friendId=e,this.msg=n,this.flag=o,this.createDate=a},ChatSnapshot:function(t,e,n,o,a){this.myId=t,this.friendId=e,this.msg=n,this.isRead=o,this.createDate=a},saveUserChatHistory:function(e,n,o,a,s){var r,i="chat-"+e+"-"+n,u=t.getStorageSync(i);r=c.isNull(u)?[]:JSON.parse(u);var l=new this.ChatHistory(e,n,o,a,s);r.push(l),t.setStorageSync(i,JSON.stringify(r))},getUserChatHistory:function(t,e,n){var o="chat-"+t+"-"+e,a=c.getListByKey(o).reverse(),s=20,r=(n-1)*s,i=[];if(a.length<r)return null;for(var u=0;u<s;u++)c.isNull(a[r+u])||i.unshift(a[r+u]);return i},deletUserChatHistory:function(e,n){var o="chat-"+e+"-"+n;t.removeStorageSync(o)},saveUserChatSnapshot:function(e,n,o,a,s){var r,i="chat-snapshot"+e,u=t.getStorageSync(i);if(c.isNull(u))r=[];else{r=JSON.parse(u);for(var l=0;l<r.length;l++)if(r[l].friendId==n){r.splice(l,1);break}}var g=new this.ChatSnapshot(e,n,o,a,s);r.unshift(g),t.setStorageSync(i,JSON.stringify(r))},getUserChatSnapShot:function(e){var n,o="chat-snapshot"+e,a=t.getStorageSync(o);return n=c.isNull(a)?[]:JSON.parse(a),n},deletUserChatSnapShot:function(e,n){var o,a="chat-snapshot"+e,s=t.getStorageSync(a);if(!c.isNull(s)){o=JSON.parse(s);for(var r=0;r<o.length;r++)if(o[r].friendId==n){o.splice(r,1);break}t.setStorageSync(a,JSON.stringify(o))}},readUserChatSnapShot:function(e,n){var o,a="chat-snapshot"+e,s=t.getStorageSync(a);if(!c.isNull(s)){o=JSON.parse(s);for(var r=0;r<o.length;r++){var i=o[r];if(i.friendId==n){i.isRead=this.READ,o.splice(r,1,i);break}}t.setStorageSync(a,JSON.stringify(o))}},fetchUnsignedChatMsg:function(){var e=this,n=c.getGlobalUserInfo(),o=",";t.request({url:c.$serverUrl+"/user/getUnsignedMsg",method:"POST",data:{userId:n.id},header:{"content-type":"application/x-www-form-urlencoded"},success:function(t){if(200==t.data.status){var n=t.data.data;if(console.log(n),!c.isNull(n)){c.$store.commit("setMyMsgCount",n.length);for(var a=0;a<n.length;a++){var s=n[a],r=new Date(s.createDate).getTime(),i=c.formatTime(r);e.saveUserChatHistory(s.acceptUserId,s.sendUserId,s.msg,e.FRIEND,i),e.saveUserChatSnapshot(s.acceptUserId,s.sendUserId,s.msg,e.UNREAD,i),o+=s.id+","}c.mySocket.signMsgList(o)}}}})}},e.default.prototype.notification={LIKEMSG_KEY:"likeMsg",COMMENTMSG_KEY:"commentMsg",saveLikeMsg:function(t){c.addIntoList(t,this.LIKEMSG_KEY)},getLikeMsg:function(t){var e=10,n=c.getListByKey(this.LIKEMSG_KEY),o=(t-1)*e,a=[];if(n.length<o)return null;for(var s=0;s<e;s++)c.isNull(n[o+s])||a.push(n[o+s]);return a},saveCommentMsg:function(t){c.addIntoList(t,this.COMMENTMSG_KEY)},getCommentMsg:function(t){var e=10,n=c.getListByKey(this.COMMENTMSG_KEY),o=(t-1)*e,a=[];if(n.length<o)return null;for(var s=0;s<e;s++)c.isNull(n[o+s])||a.push(n[o+s]);return a},fetchUnsignedLikeMsg:function(){var e=c.getGlobalUserInfo(),n=",",o=",";t.request({url:c.$serverUrl+"/article/getUnsignedLikeMsg",method:"POST",data:{userId:e.id},header:{"content-type":"application/x-www-form-urlencoded"},success:function(t){if(200==t.data.status){var e=t.data.data;if(console.log(e),!c.isNull(e)){for(var a=0;a<e.length;a++){var s=e[a];switch(c.$store.commit("setMyMsgCount"),c.$store.commit("setLikeMsgCount"),s.data.source.createDate=c.formatTime(s.data.source.createDate),c.notification.saveLikeMsg(s),s.action){case c.netty.LIKEARTICLE:n+=s.data.source.id+",";break;case c.netty.LIKECOMMENT:o+=s.data.source.id+",";break;default:break}}c.mySocket.signLikeArticleList(n),c.mySocket.signLikeCommentList(o)}}}})},fetchUnsignedCommentMsg:function(){var e=c.getGlobalUserInfo(),n=",";t.request({url:c.$serverUrl+"/article/getUnsignedCommentMsg",method:"POST",data:{userId:e.id},header:{"content-type":"application/x-www-form-urlencoded"},success:function(t){if(200==t.data.status){var e=t.data.data;if(console.log(e),!c.isNull(e)){for(var o=0;o<e.length;o++){var a=e[o];c.$store.commit("setMyMsgCount"),c.$store.commit("setCommentMsgCount"),a.data.source.createDate=c.formatTime(a.data.source.createDate),c.notification.saveCommentMsg(a),n+=a.data.source.id+","}c.mySocket.signCommentList(n)}}}})}},e.default.prototype.netty={CONNECT:1,CHAT:2,SIGNED:3,KEEPALIVE:4,LIKEARTICLE:5,LIKECOMMENT:6,COMMENTARTICLE:7,COMMENTCOMMENT:8,LIKEARTICLE_SIGN:9,LIKECOMMENT_SIGN:10,COMMENT_SIGN:11,ChatMessage:function(t,e,n,o,a){this.senderId=t,this.receiverId=e,this.msg=n,this.msgId=o,this.createDate=a},DataContent:function(t,e,n){this.action=t,this.data=e,this.extand=n}},e.default.prototype.formatTime=function(t){t.length<13&&(t+="000");var e=new Date(parseInt(t)),n=(e.getFullYear(),this.getTwo(e.getMonth()+1)),o=this.getTwo(e.getDate()),a=this.getTwo(e.getHours()),s=this.getTwo(e.getMinutes());this.getTwo(e.getSeconds());return n+"/"+o+" "+a+":"+s},e.default.prototype.getTwo=function(t){return parseInt(t)<10?"0"+t:""+t}}).call(this,n("6e42")["default"])},a773:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var o={onLaunch:function(){console.log("App Launch")},onShow:function(){console.log("App Show")},onHide:function(){console.log("App Hide")}};e.default=o}},[["9ebf","common/runtime","common/vendor"]]]);